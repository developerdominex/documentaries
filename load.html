<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Train NLP Model</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://unpkg.com/compromise@13.11.3/builds/compromise.min.js"></script>
<style>
body { font-family: "Segoe UI", sans-serif; background: #f9fafb; padding: 20px; color: #222; }
button { padding: 10px 18px; font-size: 15px; border-radius: 6px; border: none; cursor: pointer; background: #2563eb; color: white; margin-top: 15px; }
button:hover { background: #1e40af; }
textarea { width: 100%; height: 200px; margin-top: 15px; font-family: monospace; font-size: 14px; }
</style>
</head>
<body>

<h1>Train NLP Sentence Generator</h1>
<p>Fetching scripts and training model in browser...</p>
<button id="trainBtn">Start Training</button>
<textarea id="generated" placeholder="Generated sentences will appear here..."></textarea>

<script>
const urls = [
  "https://api.allorigins.win/raw?url=http://www.dailyscript.com/scripts/eight-millimeter.html",
  "https://api.allorigins.win/raw?url=http://www.scifiscripts.com/scripts/5thelement.txt",
  "https://api.allorigins.win/raw?url=http://www.awesomefilm.com/script/48hours.txt",
  "https://api.allorigins.win/raw?url=http://www.scifiscripts.com/scripts/2001.txt",
  "https://api.allorigins.win/raw?url=http://www.dailyscript.com/scripts/Alien_Nation_Bannon_Cameron_October_1987.html",
  "https://api.allorigins.win/raw?url=http://www.horrorlair.com/scripts/aliens.html"
];

async function fetchAllText() {
  let combined = "";
  for (const link of urls) {
    try {
      const res = await fetch(link);
      let text = await res.text();
      text = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').toLowerCase();
      combined += text + " ";
    } catch(e) { console.warn("Failed to fetch", link); }
  }
  return combined;
}

// Tokenize words and create sequences
function prepareSequences(text, seqLength = 20) {
  const words = text.split(/\s+/);
  const vocab = Array.from(new Set(words));
  const word2idx = {};
  const idx2word = {};
  vocab.forEach((w,i) => { word2idx[w] = i; idx2word[i] = w; });

  const sequences = [];
  const labels = [];
  for (let i=0; i<words.length-seqLength; i++) {
    const seq = words.slice(i, i+seqLength).map(w => word2idx[w]);
    sequences.push(seq.slice(0, seq.length-1));
    labels.push(seq[seq.length-1]);
  }
  return { sequences, labels, vocabSize: vocab.length, word2idx, idx2word };
}

// Build a simple LSTM model
function buildModel(vocabSize, seqLength) {
  const model = tf.sequential();
  model.add(tf.layers.embedding({ inputDim: vocabSize, outputDim: 128, inputLength: seqLength-1 }));
  model.add(tf.layers.lstm({ units: 256, returnSequences: false }));
  model.add(tf.layers.dense({ units: vocabSize, activation: 'softmax' }));
  model.compile({ optimizer: 'adam', loss: 'sparseCategoricalCrossentropy' });
  return model;
}

// Generate text from trained model
async function generateText(model, idx2word, word2idx, seqLength, seed="the", length=30) {
  let words = seed.split(" ");
  for (let i=0; i<length; i++) {
    let seq = words.slice(-seqLength+1).map(w => word2idx[w] || 0);
    while (seq.length < seqLength-1) seq.unshift(0);
    const input = tf.tensor([seq]);
    const pred = model.predict(input);
    const idx = (await pred.argMax(-1).data())[0];
    words.push(idx2word[idx]);
  }
  return words.join(" ");
}

document.getElementById("trainBtn").addEventListener("click", async () => {
  const text = await fetchAllText();
  const seqLength = 20;
  const { sequences, labels, vocabSize, word2idx, idx2word } = prepareSequences(text, seqLength);

  const xs = tf.tensor2d(sequences);
  const ys = tf.tensor1d(labels, 'int32');

  const model = buildModel(vocabSize, seqLength);

  await model.fit(xs, ys, { epochs: 5, batchSize: 128 });
  xs.dispose(); ys.dispose();

  const generated = await generateText(model, idx2word, word2idx, seqLength, "i am", 50);
  document.getElementById("generated").value = generated;
});
</script>

</body>
</html>
