<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Collect: Full Article Text — Kings/Monarchs by Country (Wikipedia)</title>
<style>
  :root{
    --bg:#0f1724; --muted:#9aa4b2; --accent:#60a5fa; --glass: rgba(255,255,255,0.03);
    --danger:#ef4444;
  }
  html,body{height:100%; margin:0; font-family:Inter,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#071028 0%,#071024 100%); color:#e6eef6;}
  .wrap{max-width:1100px;margin:20px auto;padding:18px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:1.2rem}
  p.lead{margin:6px 0 14px;color:var(--muted);max-width:680px}
  .controls{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#06202b;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);font-weight:600}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-top:12px}
  .card h3{margin:0 0 8px;font-size:1rem;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .meta{font-size:0.85rem;color:var(--muted)}
  .result-list{margin:10px 0 0;padding:8px;background:var(--glass);border-radius:8px;max-height:360px;overflow:auto;font-family:ui-monospace,monospace;font-size:0.95rem;white-space:pre-wrap}
  .line{padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
  .small{font-size:0.85rem;color:var(--muted)}
  .status{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:600}
  .status.ok{background:rgba(96,165,250,0.12);color:var(--accent)}
  .status.warn{background:rgba(250,204,21,0.08);color:#f59e0b}
  .status.err{background:rgba(239,68,68,0.08);color:var(--danger)}
  .footer{margin-top:16px;color:var(--muted);font-size:0.9rem}
  .copybtn{margin-left:8px;padding:6px 9px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--accent);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .progressbar{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:12px}
  .progress{height:100%;background:linear-gradient(90deg,rgba(96,165,250,0.9),rgba(96,165,250,0.6));width:0%}
  pre.copybox{white-space:pre-wrap;background:#021124;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-family:ui-monospace,monospace;font-size:0.9rem;max-height:360px;overflow:auto}
  @media(min-width:900px){ .two{display:grid;grid-template-columns:1fr 1fr;gap:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Collect: Full Article Text — Kings/Monarchs (Wikipedia)</h1>
        <p class="lead">This page attempts to locate a relevant Wikipedia article for each country (likely "List of monarchs", "List of heads of state", or related pages) and fetch the <strong>full article text</strong> (the main article body). Click Start Fetch to begin. Use Copy per country or Download JSON to save everything.</p>
      </div>
      <div class="controls">
        <button id="startBtn">Start Fetch</button>
        <button id="copyAllBtn" class="ghost">Copy All</button>
        <button id="downloadBtn" class="ghost">Download JSON</button>
      </div>
    </header>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Progress</strong> <span class="small" id="progressText">Idle</span></div>
        <div><span id="stats" class="small">0 / 0 processed</span></div>
      </div>
      <div class="progressbar" aria-hidden><div id="progress" class="progress"></div></div>
    </div>

    <div id="results"></div>

    <div class="footer">
      <p>Important: This client-side tool queries the live Wikipedia API. Expect the run to take several minutes. If you need a full, authoritative dataset for every historic monarch, a server-side pipeline using Wikipedia dumps is recommended.</p>
    </div>
  </div>

<script>
/* Full-article collect script
   - For each country, try multiple search templates
   - For matched page, call action=parse&prop=text to get page HTML
   - Extract all readable text from .mw-parser-output and store it
   - Show the full text in the UI and allow copying/downloading
*/

const COUNTRIES = [
"Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde (Cape Verde)","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo, Republic of the","Congo, Democratic Republic of the","Costa Rica","Côte d’Ivoire","Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Korea","North Macedonia","Norway","Oman","Pakistan","Palau","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","São Tomé and Príncipe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu","Vatican City","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"
];

// search templates to try
const SEARCH_QUERIES = [
  'List of monarchs of {country}',
  'List of kings of {country}',
  'Monarchs of {country}',
  'Kings of {country}',
  'List of heads of state of {country}',
  'Heads of state of {country}',
  '{country} monarchy',
  '{country} monarchy history',
  '{country} royal family'
];

const WIKIPEDIA_API_BASE = 'https://en.wikipedia.org/w/api.php?origin=*';
const delayBetweenRequests = 700; // ms
let resultsData = [];
let total = COUNTRIES.length;
let done = 0;

const resultsEl = document.getElementById('results');
const startBtn = document.getElementById('startBtn');
const copyAllBtn = document.getElementById('copyAllBtn');
const downloadBtn = document.getElementById('downloadBtn');
const progressEl = document.getElementById('progress');
const progressText = document.getElementById('progressText');
const statsEl = document.getElementById('stats');

startBtn.addEventListener('click', () => {
  startBtn.disabled = true;
  resultsEl.innerHTML = '';
  resultsData = [];
  done = 0;
  progressText.textContent = 'Starting…';
  statsEl.textContent = `0 / ${total} processed`;
  runAll();
});

copyAllBtn.addEventListener('click', async () => {
  const text = resultsData.map(r => `${r.country}\n\n${r.fullText || '(no text)'}\n\n`).join('\n');
  await copyToClipboard(text);
  alert('All collected full texts copied to clipboard.');
});

downloadBtn.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(resultsData, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'monarchs_fulltext_by_country.json';
  a.click();
  URL.revokeObjectURL(url);
});

async function runAll(){
  for (let i=0;i<COUNTRIES.length;i++){
    const country = COUNTRIES[i];
    updateProgress(i, COUNTRIES.length);
    const cardEl = createCountryCard(country);
    resultsEl.appendChild(cardEl);
    try {
      const res = await fetchFullArticleForCountry(country);
      resultsData.push(res);
      populateCardWithResult(cardEl, res);
    } catch(err){
      console.error('error for',country,err);
      const res = {country, error: String(err), fullText:null, pageTitle:null, pageUrl:null};
      resultsData.push(res);
      populateCardWithResult(cardEl, res);
    }
    await sleep(delayBetweenRequests);
    done++;
    statsEl.textContent = `${done} / ${total} processed`;
  }
  progressText.textContent = 'Completed';
  progressEl.style.width = '100%';
  startBtn.disabled = false;
}

function updateProgress(index, totalCount){
  const pct = Math.round((index/totalCount)*100);
  progressEl.style.width = pct + '%';
  progressText.textContent = `${index} / ${totalCount} started`;
}

function createCountryCard(country){
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `
    <h3>${escapeHtml(country)} <span id="status-${idFrom(country)}" class="status small">queued</span></h3>
    <div class="meta small">Source: <span id="src-${idFrom(country)}">—</span></div>
    <div id="list-${idFrom(country)}" class="result-list small">Waiting...</div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button class="copybtn" id="copy-${idFrom(country)}">Copy</button>
      <button class="copybtn" id="open-${idFrom(country)}">Open page</button>
      <span id="size-${idFrom(country)}" class="small" style="margin-left:auto;color:var(--muted)"></span>
    </div>
  `;
  return el;
}

function populateCardWithResult(cardEl, res){
  const id = idFrom(res.country);
  const statusEl = cardEl.querySelector(`#status-${id}`);
  const srcEl = cardEl.querySelector(`#src-${id}`);
  const listEl = cardEl.querySelector(`#list-${id}`);
  const copyBtn = cardEl.querySelector(`#copy-${id}`);
  const openBtn = cardEl.querySelector(`#open-${id}`);
  const sizeEl = cardEl.querySelector(`#size-${id}`);

  if (res.error){
    statusEl.textContent = 'error';
    statusEl.className = 'status err';
    srcEl.textContent = 'none';
    listEl.innerHTML = `<div class="line">Error: ${escapeHtml(res.error)}</div>`;
    copyBtn.addEventListener('click', ()=>{ copyToClipboard(`${res.country}\nError: ${res.error}`); });
    openBtn.disabled = true;
    return;
  }

  const hasText = !!res.fullText;
  statusEl.textContent = hasText ? 'ok' : 'no match';
  statusEl.className = hasText ? 'status ok' : 'status warn';
  srcEl.textContent = res.pageTitle ? res.pageTitle : 'none';

  listEl.innerHTML = '';
  if (res.fullText){
    const pre = document.createElement('pre');
    pre.className = 'copybox';
    pre.textContent = res.fullText;
    listEl.appendChild(pre);
    sizeEl.textContent = `${res.fullText.length} chars`;
  } else {
    listEl.innerHTML = '<div class="line">No full text could be extracted from matched pages.</div>';
    sizeEl.textContent = '';
  }

  copyBtn.addEventListener('click', async ()=>{
    const text = res.fullText || `(no text)`;
    await copyToClipboard(`${res.country}\n\n${text}`);
    copyBtn.textContent = 'Copied ✓';
    setTimeout(()=>copyBtn.textContent = 'Copy',1200);
  });

  openBtn.addEventListener('click', ()=>{
    if (res.pageUrl) window.open(res.pageUrl,'_blank');
    else alert('No page URL available for this country.');
  });
}

// Try to find a matching page, then fetch its full HTML and extract all readable text
async function fetchFullArticleForCountry(country){
  // try each query template
  for (const tmpl of SEARCH_QUERIES){
    const q = tmpl.replace('{country}', country);
    const searchUrl = `${WIKIPEDIA_API_BASE}&action=query&list=search&srsearch=${encodeURIComponent(q)}&srlimit=3&format=json`;
    try {
      const sr = await fetchJson(searchUrl);
      if (sr && sr.query && sr.query.search && sr.query.search.length>0){
        for (const page of sr.query.search){
          const title = page.title;
          try {
            const parsed = await fetchPageHtmlByTitle(title);
            const extracted = extractReadableTextFromParseHtml(parsed.html);
            if (extracted && extracted.trim().length>50) {
              return {country, pageTitle: parsed.title, pageUrl: parsed.url, fullText: extracted};
            }
            // If extracted small, try next search result
          } catch(e){
            // try next result
          }
          await sleep(150);
        }
      }
    } catch(e){
      // ignore and try next template
    }
  }

  // final fallback: broad search for the country
  try {
    const sr = await fetchJson(`${WIKIPEDIA_API_BASE}&action=query&list=search&srsearch=${encodeURIComponent(country + ' monarchy OR kings OR heads of state')}&srlimit=3&format=json`);
    if (sr && sr.query && sr.query.search && sr.query.search.length>0){
      for (const page of sr.query.search){
        const title = page.title;
        try {
          const parsed = await fetchPageHtmlByTitle(title);
          const extracted = extractReadableTextFromParseHtml(parsed.html);
          if (extracted && extracted.trim().length>50) {
            return {country, pageTitle: parsed.title, pageUrl: parsed.url, fullText: extracted};
          }
        } catch(e){ }
        await sleep(150);
      }
    }
  } catch(e){}

  return {country, pageTitle:null, pageUrl:null, fullText:null};
}

// fetch parse HTML for a given article title
async function fetchPageHtmlByTitle(title){
  const url = `${WIKIPEDIA_API_BASE}&action=parse&page=${encodeURIComponent(title)}&prop=text&format=json`;
  const data = await fetchJson(url);
  if (!data || !data.parse) throw new Error('No parse result for ' + title);
  const html = data.parse.text['*'];
  const pageUrl = 'https://en.wikipedia.org/wiki/' + encodeURIComponent(title.replace(/ /g,'_'));
  return {html, url: pageUrl, title: data.parse.title};
}

// extract readable text from the parse HTML - will take everything in .mw-parser-output
function extractReadableTextFromParseHtml(htmlString){
  if (!htmlString) return null;
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlString, 'text/html');
  // prefer .mw-parser-output (the article body)
  const content = doc.querySelector('.mw-parser-output') || doc.body;
  if (!content) return null;

  // remove elements we don't want: tables (infoboxes), edit sections, references, navboxes
  const selectorsToRemove = [
    'table.infobox', '.navbox', '.metadata', '.reference', '.vertical-navbox', '.hatnote',
    '.toc', '.mw-editsection', 'sup.reference', '.reflist', 'style', 'script'
  ];
  selectorsToRemove.forEach(sel => {
    content.querySelectorAll(sel).forEach(n => n.remove());
  });

  // convert content to plain text, preserving headings and list items
  // We'll walk child nodes and build a readable text.
  const out = [];
  function appendLine(txt){
    if (txt && txt.trim()) out.push(txt.trim());
  }

  // helper to get text of element, but collapse whitespace and remove citation brackets like [1]
  function nodeText(node){
    let t = node.textContent || '';
    // remove bracketed reference numbers [1], [a], [note 1]
    t = t.replace(/\[[^\]]*?\]/g, '');
    // collapse whitespace
    t = t.replace(/\s+/g, ' ');
    return t.trim();
  }

  // iterate children to preserve rough structure
  content.childNodes.forEach(child => {
    if (child.nodeType === Node.ELEMENT_NODE){
      const tag = child.tagName.toLowerCase();
      if (tag === 'p'){
        const t = nodeText(child);
        if (t) appendLine(t + '\n');
      } else if (tag.match(/^h[1-6]$/)){
        const t = nodeText(child);
        if (t) appendLine('\n' + t + '\n');
      } else if (tag === 'ul' || tag === 'ol'){
        const items = Array.from(child.querySelectorAll('li')).map(li => nodeText(li)).filter(Boolean);
        items.forEach(it => appendLine('- ' + it));
      } else if (tag === 'table'){
        // skip
      } else if (tag === 'div'){
        const t = nodeText(child);
        if (t && t.length < 500) appendLine(t);
        else if (t && t.length >= 500) appendLine(t.slice(0, 800) + '...'); // huge divs truncated
      }
    } else if (child.nodeType === Node.TEXT_NODE){
      const t = child.textContent.trim();
      if (t) appendLine(t);
    }
  });

  // Fallback: if out empty, try full textContent of content
  let final = out.join('\n\n').trim();
  if (!final){
    final = nodeText(content);
  }
  // Clean extra whitespace lines
  final = final.replace(/\n{3,}/g, '\n\n').trim();
  return final;
}

// utility to fetch JSON
async function fetchJson(url){
  const r = await fetch(url);
  if (!r.ok) throw new Error('Network error: ' + r.status);
  return r.json();
}

function idFrom(s){ return s.replace(/[^a-z0-9]/gi,'_'); }

async function copyToClipboard(text){
  if (navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text);
  } else {
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }
}

function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }
</script>
</body>
</html>
